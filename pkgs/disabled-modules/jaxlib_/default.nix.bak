{ buildPythonPackage
, fetchFromGitHub
, inputs
, fetchPypi
, stdenv
, scipy
, numpy
, ml-dtypes
, pip
, opt-einsum
, absl-py
, breakpointHook
, matplotlib
}
:
let
  wheelUrls = {
    "x86_64-linux" = {
      url = "https://files.pythonhosted.org/packages/8e/d7/65b1f5cf05d9159abd5882a51695d4d1b386bc8e26140eff7159854777f2/jaxlib-0.4.28-cp311-cp311-manylinux2014_x86_64.whl";
      hash = "sha256-Rc4PPIQM/4I2z/JsN/Jsn/B4aV+T4MFiwyDCgfUEEnU=";
    };

    "aarch64-linux" = {
      url = "https://files.pythonhosted.org/packages/f2/87/0c07ec3ba047ca58c940d1c3050cd08c4390bca992cdfeeb2d9d356cd2c6/jaxlib-0.4.28-cp311-cp311-manylinux2014_aarch64.whl";
      hash = "";
    };
  
    "x86_64-darwin" = {
      url = "https://files.pythonhosted.org/packages/e0/b2/896d8d1f35e16e9f88ae6a753012e6d5a6882507ea58e7f0dd5af68ee1e8/jaxlib-0.4.28-cp311-cp311-macosx_10_14_x86_64.whl";
      hash = "";
    };

    "aarch64-darwin" = {
      url = "https://files.pythonhosted.org/packages/75/f3/1ce8b092ca68dfcfa6a0ee0a8a410f6d877e1628c05799c5d03757682c66/jaxlib-0.4.28-cp311-cp311-macosx_11_0_arm64.whl";
      hash = "";
    };
  };
in
buildPythonPackage rec {
  pname = "jaxlib";
  version = "0.4.28";

  src = fetchFromGitHub {
    owner = "google";
    repo = "jax";
    rev = "jaxlib-v${version}";
    hash = "sha256-qSHPwi3is6Ts7pz5s4KzQHBMbcjGp+vAOsejW3o36Ek=";
  };

  #unpackPhase = ''
    #mkdir source
    #cp -rv $src/jaxlib source
    #chmod -R +w source
    #ls -alsph source

    #ln -rsv $src/jax/version.py source/jaxlib
    #cd source/jaxlib
  #'';

  preConfigure = ''
    cd jaxlib
    mkdir jaxlib
    ln -rsv $src/jax/version.py jaxlib/version.py
    ln -rsv $src/third_party/xla jaxlib/xla_extension
    ls -alsph .
  '';

  nativeBuildInputs = [
    breakpointHook
  ];

  nativeCheckInputs = [
    pip
  ];

  propagatedBuildInputs = [
    scipy
    numpy
    ml-dtypes
    opt-einsum
    absl-py
    matplotlib
  ];

  preferLocalBuild = true;
}
